---
title: "Analysis on the Cessation Effect on Smoking among Patients with MDD with the Combination Treatment of Behavioral Activation and Varenicline"
author: "William Qian"
date: "November 2024"
output: pdf_document
---

```{r setup, include=FALSE, message = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
library(mice, warn.conflicts = FALSE)
library(naniar)
library(ggplot2)
library(dplyr)
library(readr)
library(tidyr)
library(readxl)
library(ggpubr)
library(gtsummary)
library(GGally)
library(ggcorrplot)
library(knitr)
library(kableExtra)
library(lubridate)
library(patchwork)
library(introdataviz)
library(glmnet)
library(gt)
library(L0Learn)
library(gridExtra)
library(purrr)
library(pROC)
library(caret) 

```

# Abstract

Major Depressive Disorder (MDD) and smoking share a strong bidirectional relationship, yet the effectiveness of combined behavioral and pharmacological interventions remains incompletely understood. This study analyzed data from 241 adult smokers with current or past MDD in a 2×2 factorial trial comparing Behavioral Activation for smoking cessation (BASC) versus standard treatment (ST), with and without varenicline. Using regularized regression approaches incorporating interaction terms, we examined relationships between smoking abstinence and baseline characteristics. Our advanced interaction model achieved superior predictive accuracy and revealed significant treatment effect heterogeneity. Varenicline emerged as the strongest predictor of cessation success, with enhanced effectiveness among heavier smokers and those with higher quit readiness. Social factors emerged as important moderators, particularly the interaction between income level and antidepressant medication use. These findings suggest the need for more personalized treatment approaches that consider both clinical and socioeconomic factors when developing smoking cessation interventions for this high-risk population.

# Introduction

Major Depressive Disorder (MDD) and smoking demonstrate a significant bidirectional relationship, with MDD patients showing higher probability of heavy smoking patterns, elevated nicotine dependence levels, and intensified withdrawal symptoms during cessation attempts. While previous studies have documented varenicline's effectiveness in smoking cessation treatment, and Behavioral Activation (BA) has emerged as a promising intervention for depression-related symptoms, we still lack comprehensive understanding of their combined therapeutic effects in treating smokers with MDD. In a recent randomized, placebo-controlled, 2×2 factorial trial comparing BA for smoking cessation (BASC) and standard behavioral treatment (ST), with and without varenicline administration, researchers found no significant advantage of BASC over ST in adult smokers with current or past MDD diagnosis.

In this report, we aim to extend the previous findings by analyzing the potential moderating effects of baseline variables on treatment outcomes and examining the predictive factors for smoking abstinence, while controlling for both behavioral intervention approaches and pharmacotherapy. We investigate multiple potential moderators, including depression-related variables (e.g., anhedonia severity, current MDD status, depression intensity), smoking-related characteristics (e.g., nicotine dependence level, daily cigarette consumption, cessation readiness), and demographic factors. Through this analysis, we expect to identify specific patient characteristics that may predict better responses to particular treatment approaches, ultimately contributing to the development of more individualized and effective smoking cessation strategies for this high-risk population.

# Data

The dataset used in this analysis contains 300 observations with 25 variables (including 1 identification column) collected from a randomized, placebo-controlled, 2×2 factorial trial involving adult smokers diagnosed with current or past major depressive disorder (MDD). In order to ensure data quality and reliability of our analysis, we firstly conducted data preprocessing to handle missing values. After removing observations with incomplete records, our final analytical sample consisted of 241 participants.

The data documented participants' demographic information, depression-related variables, and smoking-related characteristics measured at baseline, as well as their treatment assignment and outcomes. The participants were randomized to receive either Behavioral Activation for smoking cessation (BASC) or standard behavioral treatment (ST), combined with either varenicline or placebo, forming a 2×2 factorial design. The completion of treatment and follow-up assessments were carefully monitored throughout the trial period.

```{r load_data, echo=FALSE, include=FALSE}
# Load the data
data <- read.csv("../Data/project2.csv")
data
```

|       Variable       |                                                                   Description                                                                   |
|:--------------------:|:-----------------------------------------------------------------------------------------------------------------------------------------------:|
|        abst          |                                                          Smoking Abstinence                                                                    |
|         Var          |                                                    Pharmacotherapy (Varenicline)                                                               |
|         BA           |                                               Psychotherapy (Behavioral Activation)                                                            |
|       age_ps         |                                                          Age at phone interview                                                                |
|       sex_ps         |                                                          Sex at phone interview                                                                |
|        NHW           |                                                   Non-Hispanic White indicator                                                                |
|       Black          |                                                              Black indicator                                                                   |
|        Hisp          |                                                            Hispanic indicator                                                                  |
|        inc           |                                         Income (ordinal categorical, low to high)                                                              |
|        edu           |                                        Education (ordinal categorical, low to high)                                                           |
|     ftcd_score       |                                                       FTCD score at baseline                                                                  |
|     ftcd.5.mins      |                                                    Smoking within 5 mins of waking up                                                         |
|    bdi_score_pq1     |                                           BDI score at baseline (a measure of depression)                                                     |
|       cpd_ps         |                                              Cigarettes per day at baseline phone survey                                                      |
|    crv_total_pq1     |                                               Cigarette reward value at baseline                                                              |
|   hedonsum_n_pq1     |                                Pleasurable Events Scale at baseline – substitute reinforcers                                                  |
|   hedonsum_y_pq1     |                              Pleasurable Events Scale at baseline – complementary reinforcers                                                 |
|  shaps_score_pq1     |  Anhedonia                         |
|     otherdiag        |                                               Other lifetime DSM-5 diagnosis                                                                  |
|    antidepmed        |                                            Taking antidepressant medication at baseline                                                      |
|      mde_curr        |                                                      Current vs past MDD                                                                      |
|        NMR           |                                                    Nicotine Metabolism Ratio                                                                  |
|    Only.Menthol      |                                          Exclusive Mentholated Cigarette User                                                                 |
|      readiness       |                                                 Baseline readiness to quit smoking                                                            |

```{r transform_data, echo=FALSE, include=FALSE}
# Transform data type
data$abst <- as.factor(data$abst)
data$Var <- as.factor(data$Var)
data$BA <- as.factor(data$BA)
data$sex_ps <- as.factor(data$sex_ps)
data$NHW <- as.factor(data$NHW)
data$Black <- as.factor(data$Black)
data$Hisp <- as.factor(data$Hisp)
data$inc <- as.factor(data$inc)
data$edu <- as.factor(data$edu)
data$otherdiag <- as.factor(data$otherdiag)
data$antidepmed <- as.factor(data$antidepmed)
data$mde_curr <- as.factor(data$mde_curr)
data$Only.Menthol <- as.factor(data$Only.Menthol)
data$readiness <- as.numeric(data$readiness)

dim(data)

summary(data)

data <- na.omit(data)
summary(data)
dim(data)

```

Analysis of the baseline characteristics by treatment groups reveals several distinctive patterns that need attention. When comparing the varenicline and placebo groups, we observe a substantial disparity in abstinence rates, with the varenicline group achieving 28% success compared to 8.4% in the placebo group (p < 0.001), indicating varenicline's potential therapeutic effectiveness. However, other baseline characteristics maintained balanced distributions between these pharmacotherapy groups, suggesting successful randomization. Similarly, when comparing behavioral activation (BA) and standard treatment groups, most characteristics were comparably distributed, with one notable exception: the proportion of participants using antidepressant medication differed significantly between groups (35% in BA group versus 19% in standard treatment group, p = 0.004).

```{r eda, echo=FALSE}
summary_var1 <- tbl_summary(data %>% select(-id), by = Var, type = list(readiness ~ "continuous")) %>% 
  add_p() %>% 
  modify_header(stat_1 = "**No Varenicline**", stat_2 = "**Varenicline**")
summary_var2 <- tbl_summary(data  %>% select(-id), by = BA, type = list(readiness ~ "continuous")) %>% 
  add_p() %>% 
  modify_header(stat_1 = "**No Psychotherapy**", stat_2 = "**Psychotherapy**")

tbl_merge(
  tbls = list(summary_var1, summary_var2),
  tab_spanner = c("**Grouped by Pharmacotherapy Status**", "**Grouped by Psychotherapy Status**")
) %>%
  as_kable_extra(booktabs = TRUE,
caption = "Data Summary Table",
longtable = TRUE, linesep = "") %>%
kableExtra::kable_styling(font_size = 8, latex_options = c("repeat_header", "HOLD_position"))

```

In our examination of the relationships among continuous variables in the dataset, we identified several significant correlations that deserve attention. The daily cigarette consumption (cpd_ps) exhibited a moderate positive correlation with the Fagerström Test for Cigarette Dependence score (FTCD score) (r = 0.517, p < 0.001). This correlation aligns with theoretical expectations, as both measures are designed to assess different aspects of smoking dependency. Furthermore, we observed that the Beck Depression Inventory score (bdi_score_w00) was negatively correlated with both measures of hedonic capacity (hedonsum_n_pq1 and hedonsum_y_pq1), a finding that supports the established relationship between increased depression severity and diminished ability to experience pleasure.

```{r continuous_validation_check, echo=FALSE, fig.width=10, fig.height=5}
continuous_vars <- data[, c("age_ps", "ftcd_score", "bdi_score_w00", "cpd_ps", "crv_total_pq1", "hedonsum_n_pq1", "hedonsum_y_pq1")]
corr_plot <- ggpairs(continuous_vars, title = "Correlation Matrix of Baseline Predictors") +
  theme_minimal()

ggsave("../Figures/corr_plot.png", plot = corr_plot, dpi = 300)
corr_plot

```

Our distribution analysis of numeric variables in the dataset identified notable right-skewed patterns in several key measures, particularly in both hedonic capacity indices (hedonsum_n_pq1, hedonsum_y_pq1) and the nicotine metabolite ratio (NMR). To address these violations of normality assumptions, we implemented log transformations for the affected variables. Post-transformation examination revealed substantially improved symmetry and reduced skewness in these distributions, ensuring their suitability for subsequent statistical analyses. We found that the remaining numeric variables, including participant age, Fagerström Test for Cigarette Dependence score, and depression-related measures, demonstrated approximately normal distributions and were therefore retained in their original scale for analysis.

```{r variable_distribution, echo=FALSE,message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
dist_numeric <- data %>%
  select(-id) %>%
  keep(is.numeric) %>% 
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram() +
    ggtitle("Distribution of Numeric Variables")

dist_cat <- data %>%
  select(-id) %>%
  keep(is.factor) %>%
  gather(key = "key", value = "value") %>%
  ggplot(aes(x = value)) +
    facet_wrap(~ key, scales = "free") +
    geom_bar()+
    ggtitle("Distribution of Categorical Variables")

gridExtra::grid.arrange(dist_numeric, dist_cat, ncol = 2)


```

This is the distribution of hedonsum_n_pq1, hedonsum_y_pq1, and NMR after log transformation.

```{r log_transform, echo=FALSE, fig.height=5, fig.width=8}
data$hedonsum_n_pq1 <- log(data$hedonsum_n_pq1 + 1)
data$hedonsum_y_pq1 <- log(data$hedonsum_y_pq1 + 1)
data$NMR <- log(data$NMR)

dist_after_log <- data %>%
  select(c(hedonsum_n_pq1, hedonsum_y_pq1, NMR)) %>%
  gather() %>% 
  ggplot(aes(value)) +
    facet_wrap(~ key, scales = "free") +
    geom_histogram() +
    ggtitle("Distribution after Log Transformation")

ggsave("../Figures/dist_after_log.png", plot = dist_after_log, dpi = 300)
dist_after_log

```

# Regresssion Analysis

## Basic Models

We first implemented two fundamental regularized regression models (Ridge and LASSO regression without interaction terms) to examine the relationship between smoking abstinence and our predictors.

```{r train_test_split, echo=FALSE}
# Split the data
set.seed(123)

train_index <- createDataPartition(data$abst, p = 0.8, list = FALSE)

train_data <- data[train_index, ] %>% select(-id)
test_data <- data[-train_index, ] %>% select(-id)

X_train <- model.matrix(abst ~ ., data = train_data)[, -1]
Y_train <- factor(train_data$abst)

X_test <- model.matrix(abst ~ ., data = test_data)[, -1]
Y_test <- factor(test_data$abst)
```

```{r model_fit, echo=FALSE}
model_fit <- function(X_train, Y_train, X_test, Y_test, alpha, lambda_seq = seq(0.001, 0.1, length.out = 100)) {
 set.seed(123)
 cv_model <- cv.glmnet(X_train, Y_train, alpha = alpha, family = "binomial", lambda = lambda_seq)
 best_lambda <- cv_model$lambda.min
 lasso_coef <- coef(cv_model, s = best_lambda)
 
 # Get predictions for both train and test sets
 train_pred <- predict(cv_model, newx = X_train, s = best_lambda, type = "response")
 test_pred <- predict(cv_model, newx = X_test, s = best_lambda, type = "response")
 
 # Convert predictions to binary using 0.5 threshold
 train_pred_binary <- ifelse(train_pred > 0.5, 1, 0)
 test_pred_binary <- ifelse(test_pred > 0.5, 1, 0)
 
 # ROC and AUC
 train_roc <- roc(Y_train, as.numeric(train_pred))
 test_roc <- roc(Y_test, as.numeric(test_pred))
 
 # Calculate metrics
 metrics <- data.frame(
   Metric = c(
     "AUC (Train)", 
     "AUC (Test)",
     "Accuracy (Train)",
     "Accuracy (Test)",
     "Lambda Min"
   ),
   Value = c(
     auc(train_roc),
     auc(test_roc),
     mean(train_pred_binary == Y_train),
     mean(test_pred_binary == Y_test),
     cv_model$lambda.min
   )
 ) %>%
   mutate(Value = round(Value, 3))

 # Create ROC curve data
 roc_df <- data.frame(
   FPR = 1 - test_roc$specificities,
   TPR = test_roc$sensitivities
 )
 
 # Create ROC plot using ggplot2
 roc_plot <- ggplot(roc_df, aes(x = FPR, y = TPR)) +
   geom_line(color = "blue", size = 1) +
   geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
   labs(
     title = paste("ROC Curve (AUC =", round(auc(test_roc), 3), ")"),
     x = "False Positive Rate",
     y = "True Positive Rate"
   ) +
   theme_minimal()

 # Create CV plot data
 cv_df <- data.frame(
   lambda = log(cv_model$lambda),
   mean = cv_model$cvm,
   upper = cv_model$cvup,
   lower = cv_model$cvlo
 )
 
 # Create CV plot using ggplot2
 cv_plot <- ggplot(cv_df, aes(x = lambda)) +
   geom_line(aes(y = mean), color = "blue") +
   geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.2) +
   geom_vline(xintercept = log(cv_model$lambda.min), linetype = "dashed", color = "red") +
   geom_vline(xintercept = log(cv_model$lambda.1se), linetype = "dashed", color = "green") +
   labs(
     title = "Cross-validation Results",
     x = "log(Lambda)",
     y = "Mean-Squared Error"
   ) +
   theme_minimal()

 # Combine plots
 combined_plot <- ggarrange(roc_plot, cv_plot, 
                          ncol = 2, 
                          labels = c("A", "B"))
 
 # Create coefficient dataframe
 coef_df <- data.frame(
   Variable = rownames(lasso_coef),
   Coefficient = as.vector(lasso_coef)
 ) %>%
 mutate(Coefficient = ifelse(Coefficient == 0, "Eliminated", round(Coefficient, 3)))
 
 return(list(
   combined_plot = combined_plot, 
   coef_df = coef_df,
   metrics = metrics
 ))
}

plot_variable_importance <- function(coef_df) {
 # Calculate variable importance by taking absolute values of non-eliminated coefficients
 var_importance <- coef_df %>%
   filter(Coefficient != "Eliminated") %>%
   mutate(
     Coefficient = as.numeric(Coefficient),
     Importance = abs(Coefficient)
   ) %>%
   arrange(desc(Importance))
 
 # Create bar plot of variable importance
 importance_plot <- ggplot(var_importance, aes(x = reorder(Variable, Importance), y = Importance)) +
   geom_bar(stat = "identity", fill = "steelblue") +
   coord_flip() + # Flip coordinates for horizontal bars
   theme_minimal() + # Use minimal theme for clean look
   labs(title = "Variable Importance",
        x = "Variables", 
        y = "Absolute Coefficient Value")
 
 # Return both plot and processed data
 return(list(
   plot = importance_plot,
   importance_df = var_importance
 ))
}
```

### Lasso Regression

Our LASSO regression model demonstrated strong predictive performance, achieving an Area Under the Curve (AUC) of 0.841 on the training dataset and 0.705 on the test dataset. Through its inherent variable selection mechanism, the LASSO model identified 10 key predictors of smoking cessation success. 

Among these predictors, varenicline treatment emerged as the most influential factor, showing the strongest positive effect (coefficient = 0.802) on abstinence probability. This coefficient indicates that varenicline administration increases the log-odds of abstinence by 0.802, which translates to an odds ratio of exp(0.802) = 2.23. In the social domain, we found that both high income level (inc5: coefficient = 0.226, odds ratio = exp(0.226) = 1.25) and antidepressant medication use (coefficient = 0.237, odds ratio = exp(0.237) = 1.27) were associated with increased likelihood of abstinence.

The impact of education levels showed heterogeneous effects in our analysis. While edu4 demonstrated a negative association with abstinence (coefficient = -0.342, reducing odds by 29% as exp(-0.342) = 0.71), edu5 showed a positive relationship (coefficient = 0.236, increasing odds by 27% as exp(0.236) = 1.27). Regarding clinical measures, we observed moderate negative associations with abstinence: each unit increase in Fagerström Test score (ftcd_score) was associated with a 16% reduction in abstinence odds (coefficient = -0.169, odds ratio = exp(-0.169) = 0.84), and similarly, each unit increase in positive hedonic capacity (hedonsum_y_pq1) corresponded to a 24% decrease in abstinence odds (coefficient = -0.280, odds ratio = exp(-0.280) = 0.76).


```{r lasso_model, fig.width=10, fig.height=5}
lambda_seq <- seq(0.001, 0.1, length.out = 100)
lasso_model <- model_fit(X_train, Y_train, X_test, Y_test, alpha = 1, lambda_seq = lambda_seq)

print(lasso_model$combined_plot)
plot_variable_importance(lasso_model$coef_df)$plot

ggsave("../Figures/lasso_model.png", plot = lasso_model$combined_plot, dpi = 300)
ggsave("../Figures/lasso_variable_importance.png", plot = plot_variable_importance(lasso_model$coef_df)$plot, dpi = 300)

```

### Ridge Regression

The Ridge regression model demonstrated stronger performance on the training set with an AUC of 0.878, though its test set performance (AUC = 0.651) was slightly lower than the LASSO model. While Ridge regression retains all variables in the model, the variable importance analysis revealed patterns similar to our LASSO findings, with varenicline treatment emerging as one of the strongest positive predictors (coefficient = 0.740, odds ratio = exp(0.740) = 2.10). Notably, both antidepressant medication use (coefficient = 0.480, odds ratio = exp(0.480) = 1.62) and Hispanic ethnicity (coefficient = 0.534, odds ratio = exp(0.534) = 1.71) showed substantial positive associations with abstinence outcomes.

Among the clinical predictors, we observed moderate positive associations for both nicotine metabolism ratio (NMR: coefficient = 0.372, increasing odds by 45% as exp(0.372) = 1.45) and menthol cigarette use (coefficient = 0.377, increasing odds by 46% as exp(0.377) = 1.46). In contrast, depression-related measures demonstrated consistent negative associations with abstinence probability. Specifically, current MDD status decreased the odds of abstinence by 26% (coefficient = -0.299, odds ratio = exp(-0.299) = 0.74), and higher scores on the positive hedonic capacity measure (hedonsum_y_pq1) were associated with reduced odds of abstinence by 28% (coefficient = -0.336, odds ratio = exp(-0.336) = 0.72).

```{r ridge_model, fig.width=10, fig.height=5}
lambda_seq <- seq(0.001, 0.1, length.out = 100)
ridge_model <- model_fit(X_train, Y_train, X_test, Y_test, alpha = 0, lambda_seq = lambda_seq)

print(ridge_model$combined_plot)
plot_variable_importance(ridge_model$coef_df)$plot

ggsave("../Figures/ridge_model.png", plot = ridge_model$combined_plot, dpi = 300)
ggsave("../Figures/ridge_variable_importance.png", plot = plot_variable_importance(ridge_model$coef_df)$plot, dpi = 300)

```

The comparison of the Ridge model and the Lasso model is shown below. The table of coefficients are also included.

```{r basic_model_comparison, echo=FALSE}
combined_table <- full_join(ridge_model$coef_df, lasso_model$coef_df, by = "Variable") %>%
  kable(
    col.names = c("Variable", "Ridge Regression Model", "Lasso Regression Model"),
    caption = "Comparison of Basic Ridge and Lasso Regression Models"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE, font_size = 8, latex_options = c("repeat_header", "HOLD_position")) %>%
  column_spec(1, bold = TRUE)

combined_table

combined_result <- full_join(ridge_model$metrics, lasso_model$metrics, by = "Metric") %>%
  kable(
    col.names = c("Metric", "Ridge Regression Model", "Lasso Regression Model"),
    caption = "Results of Basic Ridge and Lasso Regression Models"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE, font_size = 8, latex_options = c("repeat_header", "HOLD_position")) %>%
  column_spec(1, bold = TRUE)

combined_result
```

## Model with Interaction Terms

Our investigation of interaction effects progressed through two stages, each guided by specific theoretical considerations.

### Basic Interaction Model

```{r}
X_train_interactions <- model.matrix(
 ~ BA + Var + 
   # Demographic variables
   age_ps + sex_ps + NHW + Black + Hisp + inc + edu +
   # Clinical and smoking-related variables  
   bdi_score_w00 + cpd_ps + ftcd_score + ftcd.5.mins +
   shaps_score_pq1 + mde_curr + crv_total_pq1 + 
   hedonsum_n_pq1 + hedonsum_y_pq1 + 
   otherdiag + antidepmed + NMR + Only.Menthol + readiness + 
   # BA interaction terms
   BA:shaps_score_pq1 +   # BA * anhedonia 
   BA:mde_curr +          # BA * current depression status
   BA:bdi_score_w00 +     # BA * depression severity
   # Varenicline interaction terms  
   Var:ftcd_score +       # Varenicline * nicotine dependence
   Var:cpd_ps +           # Varenicline * cigarettes per day
   Var:readiness,         # Varenicline * readiness to quit
 data = train_data %>% select(-abst))[, -1]

X_test_interactions <- model.matrix(
 ~ BA + Var + 
   # Demographic variables
   age_ps + sex_ps + NHW + Black + Hisp + inc + edu +
   # Clinical and smoking-related variables
   bdi_score_w00 + cpd_ps + ftcd_score + ftcd.5.mins +
   shaps_score_pq1 + mde_curr + crv_total_pq1 + 
   hedonsum_n_pq1 + hedonsum_y_pq1 + 
   otherdiag + antidepmed + NMR + Only.Menthol + readiness + 
   # BA interaction terms
   BA:shaps_score_pq1 +   # BA * anhedonia
   BA:mde_curr +          # BA * current depression status  
   BA:bdi_score_w00 +     # BA * depression severity
   # Varenicline interaction terms
   Var:ftcd_score +       # Varenicline * nicotine dependence
   Var:cpd_ps +           # Varenicline * cigarettes per day
   Var:readiness,         # Varenicline * readiness to quit
 data = test_data %>% select(-abst))[, -1]
```

In constructing our basic interaction model, we prioritized the examination of treatment-specific interactions that aligned with our primary research objectives regarding treatment effectiveness. For Behavioral Activation (BA), we specifically focused on its interactions with depression-related variables, including current MDD status (mde_curr), Beck Depression Inventory score (bdi_score_w00), and Snaith-Hamilton Pleasure Scale score (shaps_score_pq1). This selection was theoretically driven, as BA was explicitly designed to target depression symptoms, with particular emphasis on addressing anhedonic symptoms. Additionally, we incorporated the interaction between BA and current MDD status to evaluate whether BA's therapeutic effectiveness varies between patients with current versus past MDD diagnoses.

Meanwhile, our analysis of varenicline interactions concentrated on smoking-related characteristics, specifically the Fagerström Test score (ftcd_score), cigarettes per day (cpd_ps), and readiness to quit measures. This selection was informed by previous research findings suggesting that pharmacotherapy outcomes may be moderated by baseline smoking intensity and motivational factors. These interaction terms were essential for understanding the differential effects of varenicline across varying levels of nicotine dependence and quit motivation.

Our initial interaction model demonstrated moderate predictive performance, achieving an AUC of 0.685 on the test dataset. The variable importance analysis revealed that varenicline maintained its position as a strong predictor, showing a substantial main effect (coefficient = 0.309) that increased the base odds of abstinence by exp(0.309) = 1.36 times. However, we found that varenicline's effectiveness exhibited variation across different baseline smoking characteristics. Particularly noteworthy was the positive interaction with daily cigarette consumption (coefficient = 0.021, odds ratio = exp(0.021) = 1.02), indicating an enhanced treatment effect with higher baseline smoking intensity. To illustrate, for participants reporting 20 cigarettes per day, varenicline's effectiveness showed an enhancement factor of exp(0.021 * 20) = 1.52 compared to its baseline effect.

In examining behavioral treatment interactions, we observed that the relationship between Behavioral Activation (BA) and current MDD status revealed a subtle but important pattern. The negative interaction coefficient (-0.013) suggests that for patients with current MDD, BA's effectiveness was marginally reduced (odds ratio = exp(-0.013) = 0.987, approximately 1.3% reduction in abstinence odds). This finding underscores the particular challenges in treating this specific patient subgroup. Additionally, our analysis revealed that educational level served as a significant moderator of treatment effectiveness, with contrasting effects observed at different levels: edu4 was associated with reduced odds of abstinence (coefficient = -0.250, odds ratio = exp(-0.250) = 0.779, representing a 22.1% reduction), while edu5 showed increased odds (coefficient = 0.215, odds ratio = exp(0.215) = 1.24, indicating a 24% increase).

```{r basic_interaction_model, fig.width=10, fig.height=5}
lambda_seq <- seq(0.001, 0.1, length.out = 100)
basic_interaction_model <- model_fit(X_train_interactions, Y_train, X_test_interactions, Y_test, alpha = 0.5, lambda_seq = lambda_seq)

print(basic_interaction_model$combined_plot)
plot_variable_importance(basic_interaction_model$coef_df)$plot

ggsave("../Figures/basic_interaction_model.png", plot = basic_interaction_model$combined_plot, dpi = 300)
ggsave("../Figures/basic_interaction_variable_importance.png", plot = plot_variable_importance(basic_interaction_model$coef_df)$plot, dpi = 300)

```

### Advanced Interaction Model

```{r}
# Create model matrix with extended interaction terms
X_train_interactions <- model.matrix(
 ~ BA + Var + 
   # Demographic variables
   age_ps + sex_ps + NHW + Black + Hisp + inc + edu +
   # Clinical and smoking-related variables
   bdi_score_w00 + cpd_ps + ftcd_score + ftcd.5.mins +
   shaps_score_pq1 + mde_curr + crv_total_pq1 + 
   hedonsum_n_pq1 + hedonsum_y_pq1 + 
   otherdiag + antidepmed + NMR + Only.Menthol + readiness + 
   # BA interaction terms
   BA:shaps_score_pq1 +   # BA * anhedonia
   BA:mde_curr +          # BA * current depression status
   BA:bdi_score_w00 +     # BA * depression severity
   BA:Black +             # BA * race (Black)
   BA:NHW +               # BA * race (Non-Hispanic White)
   # Varenicline interaction terms
   Var:ftcd_score +       # Varenicline * nicotine dependence
   Var:cpd_ps +           # Varenicline * cigarettes per day
   Var:readiness +        # Varenicline * readiness to quit
   Var:Black +            # Varenicline * race (Black)
   Var:NHW +              # Varenicline * race (Non-Hispanic White)
   # Depression symptom interactions
   bdi_score_w00:shaps_score_pq1 +  # Depression severity * anhedonia
   mde_curr:shaps_score_pq1 +       # Current depression status * anhedonia
   # Smoking behavior interactions
   ftcd_score:cpd_ps +          # Nicotine dependence * cigarettes per day
   ftcd_score:readiness +       # Nicotine dependence * readiness to quit
   # social status interactions
   antidepmed:inc +             # Antidepressant medication * income
   edu:readiness +              # Education * readiness to quit
   # Menthol cigarette interactions
   Only.Menthol:ftcd_score +    # Menthol use * nicotine dependence
   Only.Menthol:NMR,            # Menthol use * nicotine metabolism ratio
 data = train_data %>% select(-abst))[, -1]

X_test_interactions <- model.matrix(
 ~ BA + Var + 
   # Demographic variables
   age_ps + sex_ps + NHW + Black + Hisp + inc + edu +
   # Clinical and smoking-related variables
   bdi_score_w00 + cpd_ps + ftcd_score + ftcd.5.mins +
   shaps_score_pq1 + mde_curr + crv_total_pq1 + 
   hedonsum_n_pq1 + hedonsum_y_pq1 + 
   otherdiag + antidepmed + NMR + Only.Menthol + readiness + 
   # BA interaction terms
   BA:shaps_score_pq1 +   # BA * anhedonia
   BA:mde_curr +          # BA * current depression status
   BA:bdi_score_w00 +     # BA * depression severity
   BA:Black +             # BA * race (Black)
   BA:NHW +               # BA * race (Non-Hispanic White)
   # Varenicline interaction terms
   Var:ftcd_score +       # Varenicline * nicotine dependence
   Var:cpd_ps +           # Varenicline * cigarettes per day
   Var:readiness +        # Varenicline * readiness to quit
   Var:Black +            # Varenicline * race (Black)
   Var:NHW +              # Varenicline * race (Non-Hispanic White)
   # Depression symptom interactions
   bdi_score_w00:shaps_score_pq1 +  # Depression severity * anhedonia
   mde_curr:shaps_score_pq1 +       # Current depression status * anhedonia
   # Smoking behavior interactions
   ftcd_score:cpd_ps +          # Nicotine dependence * cigarettes per day
   ftcd_score:readiness +       # Nicotine dependence * readiness to quit
   # social status interactions
   antidepmed:inc +             # Antidepressant medication * income
   edu:readiness +              # Education * readiness to quit
   # Menthol cigarette interactions
   Only.Menthol:ftcd_score +    # Menthol use * nicotine dependence
   Only.Menthol:NMR,            # Menthol use * nicotine metabolism ratio
 data = test_data %>% select(-abst))[, -1]
```

In developing our advanced interaction model, we expanded the scope of our analysis to incorporate a more comprehensive set of theoretically grounded interactions, focusing on three fundamental mechanisms. Firstly, we investigated the interaction between depression symptoms, specifically examining the relationship between Beck Depression Inventory score and Snaith-Hamilton Pleasure Scale score (bdi_score_w00 × shaps_score_pq1). This interaction was selected based on the hypothesis that concurrent presence of severe depression and pronounced anhedonia might create uniquely challenging conditions for achieving smoking cessation.

Secondly, we examined potential interactions between smoking behavior characteristics and quit motivation (ftcd_score × readiness). This investigation was driven by the theoretical premise that elevated levels of nicotine dependence, as measured by the Fagerström Test score, might attenuate the typically positive influence of quit motivation on cessation outcomes. Finally, we explored social interactions, particularly focusing on education level's interaction with quit readiness (edu × readiness) and income level's interaction with antidepressant medication use (inc × antidepmed). These interactions were chosen to investigate how educational background might moderate the translation of motivation into successful cessation, and how social factors might influence medication effectiveness through differential access to healthcare resources and support systems.

Our advanced interaction model demonstrated superior predictive performance, achieving the highest test set Area Under the Curve (AUC) of 0.711. This improvement in predictive accuracy suggests that the incorporation of comprehensive interaction terms successfully captured important complex relationships in the data. The variable importance analysis revealed several notable interaction patterns that warrant detailed examination.

The most prominent finding emerged from the social domain, where we observed a strong interaction between middle income level and antidepressant medication use (coefficient = 1.204, odds ratio = exp(1.204) = 3.33). This substantial effect indicates that participants in the middle income group experienced more than triple the effectiveness from antidepressant medication compared to other income groups. Treatment-related interactions also demonstrated meaningful patterns: varenicline's effectiveness showed positive interaction with both daily cigarette consumption (coefficient = 0.019, odds ratio per cigarette = exp(0.019) = 1.019) and readiness to quit (coefficient = 0.017, odds ratio per unit = exp(0.017) = 1.017). To illustrate, for participants smoking 20 cigarettes per day, the varenicline treatment effect was enhanced by a factor of exp(0.019 * 20) = 1.46.

The model additionally captured significant behavioral interactions that provide insights into treatment mechanisms. We found that increased nicotine dependence slightly attenuated the benefit of quit readiness (coefficient = -0.011, odds ratio = exp(-0.011) = 0.989 per unit increase in dependence score). Similarly, educational background emerged as a modifier of quit readiness effects, with edu4 level showing a modest negative interaction (coefficient = -0.014, odds ratio = exp(-0.014) = 0.986 per unit increase in readiness score). These findings suggest that both nicotine dependence and educational background influence how effectively quit motivation translates into successful abstinence outcomes.

```{r advanced_interaction_model, fig.width=10, fig.height=5}
lambda_seq <- seq(0.001, 0.1, length.out = 100)
advanced_interaction_model <- model_fit(X_train_interactions, Y_train, X_test_interactions, Y_test, alpha = 0.5, lambda_seq = lambda_seq)

print(advanced_interaction_model$combined_plot)
plot_variable_importance(advanced_interaction_model$coef_df)$plot

ggsave("../Figures/advanced_interaction_model.png", plot = advanced_interaction_model$combined_plot, dpi = 300)
ggsave("../Figures/advanced_interaction_variable_importance.png", plot = plot_variable_importance(advanced_interaction_model$coef_df)$plot, dpi = 300)

```

```{r interaction_model_comparison}
combined_table <- full_join(basic_interaction_model$coef_df, advanced_interaction_model$coef_df, by = "Variable") %>%
  kable(
    col.names = c("Variable", "Model with Basic Interaction Term", "Model with Advanced Interaction Terms"),
    caption = "Comparison of Models with Interaction Terms"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE, font_size = 8, latex_options = c("repeat_header", "HOLD_position")) %>%
  column_spec(1, bold = TRUE) # Make Variable column bold

combined_table

combined_result <- full_join(basic_interaction_model$metrics, advanced_interaction_model$metrics, by = "Metric") %>%
  kable(
    col.names = c("Metric", "Model with Basic Interaction Term", "Model with Advanced Interaction Terms"),
    caption = "Results of Models with Interaction Terms"
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), 
                full_width = FALSE, font_size = 8, latex_options = c("repeat_header", "HOLD_position")) %>%
  column_spec(1, bold = TRUE) # Make Metric column bold

combined_result

```

# Discussion

In this study, we employed a series of regularized regression models to investigate the effectiveness of behavioral activation and varenicline for smoking cessation among individuals with current or past MDD. Through progressively complex modeling approaches, from basic LASSO and Ridge regression to interaction models, we gained several key insights about treatment effects and their moderators.

Our analytical models demonstrated consistently robust predictive performance, with test AUC values ranging from 0.651 to 0.711. The advanced interaction model achieved the highest predictive accuracy, highlighting the importance of considering treatment effect heterogeneity in our analysis. Notably, the relatively small gap between training and test performance (AUC difference < 0.15) suggests our models successfully avoided severe overfitting, which we attribute to the effective implementation of regularization strategies.

Regarding treatment effectiveness, varenicline emerged as a consistently strong predictor of smoking cessation success across all model specifications. The basic LASSO model identified a substantial positive effect (coefficient = 0.802), which maintained its robustness even after accounting for various interaction terms. In contrast, behavioral activation demonstrated more modest and variable effects, with the lack of a strong main effect aligning with previous trial findings where BASC showed no significant advantage over standard behavioral treatment.

Our interaction models revealed significant heterogeneity in treatment effects across different patient subgroups. For varenicline, we observed enhanced effectiveness among heavier smokers (Var × cpd_ps: 0.019) and participants with higher readiness to quit (Var × readiness: 0.017), suggesting particular benefit for more severely dependent smokers who demonstrate strong quit motivation. For behavioral activation, the negative interaction with current MDD status (BA × mde_curr: -0.013) indicated potentially reduced effectiveness among currently depressed patients, underscoring the challenges in treating this specific subgroup.

The advanced interaction model uncovered important social dimensions of treatment response. We identified a strong positive interaction between middle income level and antidepressant medication use (inc3 × antidepmed: 1.204), suggesting significant social moderation of depression treatment effectiveness. Additionally, the negative interaction between education level and quit readiness (edu4 × readiness: -0.014) indicated that the translation of quit motivation into successful cessation varies across educational backgrounds.

Several limitations should be noted in our analysis. First, our relatively small sample size (n=241 after removing missing values) may have limited our ability to detect smaller interaction effects. Second, our binary outcome measure may not fully capture the complexity of smoking cessation trajectories. Third, our models did not account for potential time-varying treatment effects or the dynamic nature of depression symptoms during quit attempts.

Future research directions should address several key areas. Larger sample sizes would enable more precise estimation of interaction effects and potentially reveal additional treatment effect moderators. The incorporation of longitudinal measures for both smoking behavior and depression symptoms could provide valuable insights into temporal dynamics of treatment effects. Additionally, more sophisticated modeling approaches, such as Bayesian methods or advanced machine learning techniques, might better capture the complex relationships between patient characteristics and treatment outcomes.

Despite these limitations, our findings yield important clinical implications. The consistent effectiveness of varenicline, particularly among heavier smokers, supports its continued use as a first-line treatment. However, the variable effects of behavioral activation and the significant role of social factors suggest the need for more personalized treatment approaches. Clinicians should carefully consider both clinical and social factors when developing smoking cessation interventions for patients with MDD.

\newpage

# References

1. Hitsman, Brian, George D. Papandonatos, Jacqueline K. Gollan, Mark D. Huffman, Raymond Niaura, David C. Mohr, Anna K. Veluz‐Wilkins, et al. “Efficacy and Safety of Combination Behavioral Activation for Smoking Cessation and Varenicline for Treating Tobacco Dependence among Individuals with Current or Past Major Depressive Disorder: A 2 × 2 Factorial, Randomized, Placebo‐controlled Trial.” Addiction 118, no. 9 (September 2023): 1710–25. https://doi.org/10.1111/add.16209.

\newpage

# Code Appendix

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}

```